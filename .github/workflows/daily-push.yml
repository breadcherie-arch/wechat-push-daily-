name: 微信每日推送

on:
  # 定时触发：每天 UTC 0:30（北京时间 8:30）
  schedule:
    - cron: '30 0 * * *'
  
  # 允许手动触发（在网页上点击运行）
  workflow_dispatch:
  
  # 当代码推送到main分支时也运行（测试用）
  push:
    branches: [ main ]

jobs:
  send-message:
    runs-on: ubuntu-latest  # 使用最新版Ubuntu系统
    
    steps:
      # 1. 获取代码
      - name: 检出代码
        uses: actions/checkout@v3
        
      # 2. 设置Python环境
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'  # 指定Python版本
          cache: 'pip'  # 缓存pip包，加快速度
          
      # 3. 安装依赖
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 4. 运行推送脚本
      - name: 运行推送任务
        env:
          # 从GitHub Secrets读取配置
          CORP_ID: ${{ secrets.CORP_ID }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AGENT_SECRET: ${{ secrets.AGENT_SECRET }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: python main.py
        
      # 5. 任务完成通知（可选）
      - name: 任务状态
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ 任务执行成功！"
          else
            echo "❌ 任务执行失败"
            echo "请查看上方日志排查问题"
          fi
