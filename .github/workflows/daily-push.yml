name: 微信每日推送

on:
  # 定时触发：每天 UTC 0:30（北京时间 8:30）
  schedule:
    - cron: '30 0 * * *'
  
  # 允许手动触发（在 GitHub 网页上手动运行）
  workflow_dispatch:
  
  # 当代码推送到 main 分支时也运行（用于测试）
  push:
    branches: [ main ]
  
  # 当创建 Pull Request 时运行（用于测试）
  pull_request:
    branches: [ main ]

jobs:
  send-message:
    # 运行在最新版的 Ubuntu 系统上
    runs-on: ubuntu-latest
    
    steps:
      # 第一步：检出代码（获取你的仓库代码）
      - name: 检出代码
        uses: actions/checkout@v3
        
      # 第二步：设置 Python 环境
      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          # 指定 Python 版本
          python-version: '3.9'
          # 启用 pip 缓存，加速构建
          cache: 'pip'
          
      # 第三步：安装依赖
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 第四步：运行推送脚本（核心步骤）
      - name: 运行推送任务
        env:
          # 从 GitHub Secrets 中读取敏感信息
          CORP_ID: ${{ secrets.CORP_ID }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AGENT_SECRET: ${{ secrets.AGENT_SECRET }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          # 其他配置（也可以在代码中写死）
          CITY_NAME: "Guangzhou,CN"
          TO_USER: "@all"
        run: python main.py
        
      # 第五步：失败通知（可选）
      - name: 任务完成通知
        if: always()  # 无论成功失败都运行
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ 推送任务执行成功！"
          else
            echo "❌ 推送任务执行失败！"
            echo "请查看日志：https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
